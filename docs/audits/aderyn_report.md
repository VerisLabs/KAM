# Aderyn Analysis Report

This report was generated by [Aderyn](https://github.com/Cyfrin/aderyn), a static analysis tool built by [Cyfrin](https://cyfrin.io), a blockchain security company. This report is not a substitute for manual audit or security review. It should not be relied upon for any purpose other than to assist in the identification of potential security vulnerabilities.
# Table of Contents

- [Summary](#summary)
  - [Files Summary](#files-summary)
  - [Files Details](#files-details)
  - [Issue Summary](#issue-summary)
- [High Issues](#high-issues)
  - [H-1: Yul block contains `return`](#h-1-yul-block-contains-return)
  - [H-2: Weak Randomness](#h-2-weak-randomness)
  - [H-3: Contract locks Ether without a withdraw function](#h-3-contract-locks-ether-without-a-withdraw-function)
  - [H-4: Reentrancy: State change after external call](#h-4-reentrancy-state-change-after-external-call)
- [Low Issues](#low-issues)
  - [L-1: Centralization Risk](#l-1-centralization-risk)
  - [L-2: Empty `require()` / `revert()` Statement](#l-2-empty-require--revert-statement)
  - [L-3: Large Numeric Literal](#l-3-large-numeric-literal)
  - [L-4: Loop Contains `require`/`revert`](#l-4-loop-contains-requirerevert)
  - [L-5: Unused State Variable](#l-5-unused-state-variable)
  - [L-6: Costly operations inside loop](#l-6-costly-operations-inside-loop)
  - [L-7: State Change Without Event](#l-7-state-change-without-event)
  - [L-8: State Variable Could Be Immutable](#l-8-state-variable-could-be-immutable)
  - [L-9: Unchecked Return](#l-9-unchecked-return)


# Summary

## Files Summary

| Key | Value |
| --- | --- |
| .sol Files | 28 |
| Total nSLOC | 2730 |


## Files Details

| Filepath | nSLOC |
| --- | --- |
| src/abstracts/Extsload.sol | 46 |
| src/abstracts/Proxy.sol | 20 |
| src/adapters/BaseAdapter.sol | 83 |
| src/adapters/CustodialAdapter.sol | 109 |
| src/base/MultiFacetProxy.sol | 59 |
| src/base/kBase.sol | 135 |
| src/interfaces/IAdapter.sol | 18 |
| src/interfaces/IExtsload.sol | 6 |
| src/interfaces/IkAssetRouter.sol | 112 |
| src/interfaces/IkBatchReceiver.sol | 19 |
| src/interfaces/IkMinter.sol | 44 |
| src/interfaces/IkRegistry.sol | 313 |
| src/interfaces/IkStakingVault.sol | 35 |
| src/interfaces/IkToken.sol | 25 |
| src/interfaces/modules/IVaultBatch.sol | 7 |
| src/interfaces/modules/IVaultClaim.sol | 5 |
| src/interfaces/modules/IVaultFees.sol | 22 |
| src/kAssetRouter.sol | 323 |
| src/kBatchReceiver.sol | 47 |
| src/kMinter.sol | 168 |
| src/kRegistry.sol | 289 |
| src/kStakingVault/base/BaseVaultModule.sol | 206 |
| src/kStakingVault/kStakingVault.sol | 210 |
| src/kStakingVault/modules/BatchModule.sol | 72 |
| src/kStakingVault/modules/ClaimModule.sol | 59 |
| src/kStakingVault/modules/FeesModule.sol | 149 |
| src/kStakingVault/types/BaseVaultModuleTypes.sol | 30 |
| src/kToken.sol | 119 |
| **Total** | **2730** |


## Issue Summary

| Category | No. of Issues |
| --- | --- |
| High | 4 |
| Low | 9 |


# High Issues

## H-1: Yul block contains `return`

This causes the transaction execution to halt, and nothing after that call will execute including code following the assembly block.

<details><summary>4 Found Instances</summary>


- Found in src/abstracts/Extsload.sol [Line: 14](src/abstracts/Extsload.sol#L14)

	```solidity
	            return(0, 0x20)
	```

- Found in src/abstracts/Extsload.sol [Line: 34](src/abstracts/Extsload.sol#L34)

	```solidity
	            return(start, sub(end, start))
	```

- Found in src/abstracts/Extsload.sol [Line: 54](src/abstracts/Extsload.sol#L54)

	```solidity
	            return(start, sub(end, start))
	```

- Found in src/abstracts/Proxy.sol [Line: 39](src/abstracts/Proxy.sol#L39)

	```solidity
	            default { return(0, returndatasize()) }
	```

</details>



## H-2: Weak Randomness

The use of keccak256 hash functions on predictable values like block.timestamp, block.number, or similar data, including modulo operations on these values, should be avoided for generating randomness, as they are easily predictable and manipulable. The `PREVRANDAO` opcode also should not be used as a source of randomness. Instead, utilize Chainlink VRF for cryptographically secure and provably random values to ensure protocol integrity.

<details><summary>2 Found Instances</summary>


- Found in src/kAssetRouter.sol [Line: 245](src/kAssetRouter.sol#L245)

	```solidity
	        proposalId = keccak256(abi.encodePacked(vault, batchId, block.timestamp, $.proposalCounter));
	```

- Found in src/kStakingVault/modules/BatchModule.sol [Line: 93](src/kStakingVault/modules/BatchModule.sol#L93)

	```solidity
	        bytes32 newBatchId = keccak256(
	```

</details>



## H-3: Contract locks Ether without a withdraw function

It appears that the contract includes a payable function to accept Ether but lacks a corresponding function to withdraw it, which leads to the Ether being locked in the contract. To resolve this issue, please implement a public or external function that allows for the withdrawal of Ether from the contract.

<details><summary>1 Found Instances</summary>


- Found in src/base/MultiFacetProxy.sol [Line: 10](src/base/MultiFacetProxy.sol#L10)

	```solidity
	contract MultiFacetProxy is Proxy, OwnableRoles {
	```

</details>



## H-4: Reentrancy: State change after external call

Changing state after an external call can lead to re-entrancy attacks.Use the checks-effects-interactions pattern to avoid this issue.

<details><summary>2 Found Instances</summary>


- Found in src/kRegistry.sol [Line: 217](src/kRegistry.sol#L217)

	State is changed at: `$.assetToKToken[asset] = kToken_`
	```solidity
	        uint8 decimals_ = IERC20Metadata(asset).decimals();
	```

- Found in src/kStakingVault/kStakingVault.sol [Line: 79](src/kStakingVault/kStakingVault.sol#L79)

	State is changed at: `$.receiverImplementation = address(new kBatchReceiver(_registry().getContractById(K_MINTER)))`
	```solidity
	        $.kToken = _registry().assetToKToken(asset_);
	```

</details>



# Low Issues

## L-1: Centralization Risk

Contracts have owners with privileged rights to perform admin tasks and need to be trusted to not perform malicious updates or drain funds.

<details><summary>14 Found Instances</summary>


- Found in src/base/MultiFacetProxy.sol [Line: 60](src/base/MultiFacetProxy.sol#L60)

	```solidity
	        onlyRoles(_proxyAdminRole())
	```

- Found in src/base/MultiFacetProxy.sol [Line: 82](src/base/MultiFacetProxy.sol#L82)

	```solidity
	    function removeFunction(bytes4 selector) public onlyRoles(_proxyAdminRole()) {
	```

- Found in src/kRegistry.sol [Line: 501](src/kRegistry.sol#L501)

	```solidity
	    function _authorizeUpgrade(address newImplementation) internal view override onlyOwner {
	```

- Found in src/kToken.sol [Line: 107](src/kToken.sol#L107)

	```solidity
	    function mint(address _to, uint256 _amount) external nonReentrant whenNotPaused onlyRoles(MINTER_ROLE) {
	```

- Found in src/kToken.sol [Line: 116](src/kToken.sol#L116)

	```solidity
	    function burn(address _from, uint256 _amount) external nonReentrant whenNotPaused onlyRoles(MINTER_ROLE) {
	```

- Found in src/kToken.sol [Line: 125](src/kToken.sol#L125)

	```solidity
	    function burnFrom(address _from, uint256 _amount) external nonReentrant whenNotPaused onlyRoles(MINTER_ROLE) {
	```

- Found in src/kToken.sol [Line: 169](src/kToken.sol#L169)

	```solidity
	    function grantAdminRole(address admin) external onlyOwner {
	```

- Found in src/kToken.sol [Line: 175](src/kToken.sol#L175)

	```solidity
	    function revokeAdminRole(address admin) external onlyOwner {
	```

- Found in src/kToken.sol [Line: 181](src/kToken.sol#L181)

	```solidity
	    function grantEmergencyRole(address emergency) external onlyRoles(ADMIN_ROLE) {
	```

- Found in src/kToken.sol [Line: 187](src/kToken.sol#L187)

	```solidity
	    function revokeEmergencyRole(address emergency) external onlyRoles(ADMIN_ROLE) {
	```

- Found in src/kToken.sol [Line: 194](src/kToken.sol#L194)

	```solidity
	    function grantMinterRole(address minter) external onlyRoles(ADMIN_ROLE) {
	```

- Found in src/kToken.sol [Line: 201](src/kToken.sol#L201)

	```solidity
	    function revokeMinterRole(address minter) external onlyRoles(ADMIN_ROLE) {
	```

- Found in src/kToken.sol [Line: 208](src/kToken.sol#L208)

	```solidity
	    function setPaused(bool isPaused_) external onlyRoles(EMERGENCY_ADMIN_ROLE) {
	```

- Found in src/kToken.sol [Line: 218](src/kToken.sol#L218)

	```solidity
	    function emergencyWithdraw(address token, address to, uint256 amount) external onlyRoles(EMERGENCY_ADMIN_ROLE) {
	```

</details>



## L-2: Empty `require()` / `revert()` Statement

Use descriptive reason strings or custom errors for revert paths.

<details><summary>2 Found Instances</summary>


- Found in src/base/MultiFacetProxy.sol [Line: 64](src/base/MultiFacetProxy.sol#L64)

	```solidity
	            if ($.selectorToImplementation[selector] != address(0)) revert();
	```

- Found in src/base/MultiFacetProxy.sol [Line: 102](src/base/MultiFacetProxy.sol#L102)

	```solidity
	        if (implementation == address(0)) revert();
	```

</details>



## L-3: Large Numeric Literal

Large literal values multiples of 10000 can be replaced with scientific notation.Use `e` notation, for example: `1e18`, instead of its full numeric value.

<details><summary>2 Found Instances</summary>


- Found in src/kStakingVault/base/BaseVaultModule.sol [Line: 51](src/kStakingVault/base/BaseVaultModule.sol#L51)

	```solidity
	    uint256 public constant ONE_HUNDRED_PERCENT = 10_000;
	```

- Found in src/kStakingVault/modules/FeesModule.sol [Line: 55](src/kStakingVault/modules/FeesModule.sol#L55)

	```solidity
	    uint256 constant MAX_BPS = 10_000;
	```

</details>



## L-4: Loop Contains `require`/`revert`

Avoid `require` / `revert` statements in a loop because a single bad item can cause the whole transaction to fail. It's better to forgive on fail and return failed elements post processing of the loop

<details><summary>2 Found Instances</summary>


- Found in src/base/MultiFacetProxy.sol [Line: 74](src/base/MultiFacetProxy.sol#L74)

	```solidity
	        for (uint256 i = 0; i < selectors.length; i++) {
	```

- Found in src/kRegistry.sol [Line: 347](src/kRegistry.sol#L347)

	```solidity
	        for (uint256 i; i < length;) {
	```

</details>



## L-5: Unused State Variable

State variable appears to be unused. No analysis has been performed to see if any inline assembly references it. Consider removing this unused variable.

<details><summary>7 Found Instances</summary>


- Found in src/adapters/BaseAdapter.sol [Line: 55](src/adapters/BaseAdapter.sol#L55)

	```solidity
	    bytes32 private constant BASE_ADAPTER_STORAGE_LOCATION =
	```

- Found in src/adapters/CustodialAdapter.sol [Line: 49](src/adapters/CustodialAdapter.sol#L49)

	```solidity
	    bytes32 private constant CUSTODIAL_ADAPTER_STORAGE_LOCATION =
	```

- Found in src/base/MultiFacetProxy.sol [Line: 12](src/base/MultiFacetProxy.sol#L12)

	```solidity
	    bytes32 internal constant MULTIFACET_PROXY_STORAGE_LOCATION =
	```

- Found in src/base/kBase.sol [Line: 61](src/base/kBase.sol#L61)

	```solidity
	    bytes32 private constant KBASE_STORAGE_LOCATION = 0xe91688684975c4d7d54a65dd96da5d4dcbb54b8971c046d5351d3c111e43a800;
	```

- Found in src/kAssetRouter.sol [Line: 52](src/kAssetRouter.sol#L52)

	```solidity
	    bytes32 private constant KASSETROUTER_STORAGE_LOCATION =
	```

- Found in src/kMinter.sol [Line: 41](src/kMinter.sol#L41)

	```solidity
	    bytes32 private constant KMINTER_STORAGE_LOCATION =
	```

- Found in src/kRegistry.sol [Line: 66](src/kRegistry.sol#L66)

	```solidity
	    bytes32 private constant KREGISTRY_STORAGE_LOCATION =
	```

</details>



## L-6: Costly operations inside loop

Invoking `SSTORE` operations in loops may waste gas. Use a local variable to hold the loop computation result.

<details><summary>2 Found Instances</summary>


- Found in src/base/MultiFacetProxy.sol [Line: 74](src/base/MultiFacetProxy.sol#L74)

	```solidity
	        for (uint256 i = 0; i < selectors.length; i++) {
	```

- Found in src/base/MultiFacetProxy.sol [Line: 90](src/base/MultiFacetProxy.sol#L90)

	```solidity
	        for (uint256 i = 0; i < selectors.length; i++) {
	```

</details>



## L-7: State Change Without Event

There are state variable changes in this function but no event is emitted. Consider emitting an event to enable offchain indexers to track the changes.

<details><summary>4 Found Instances</summary>


- Found in src/base/MultiFacetProxy.sol [Line: 54](src/base/MultiFacetProxy.sol#L54)

	```solidity
	    function addFunction(
	```

- Found in src/base/MultiFacetProxy.sol [Line: 73](src/base/MultiFacetProxy.sol#L73)

	```solidity
	    function addFunctions(bytes4[] calldata selectors, address implementation, bool forceOverride) external {
	```

- Found in src/base/MultiFacetProxy.sol [Line: 82](src/base/MultiFacetProxy.sol#L82)

	```solidity
	    function removeFunction(bytes4 selector) public onlyRoles(_proxyAdminRole()) {
	```

- Found in src/base/MultiFacetProxy.sol [Line: 89](src/base/MultiFacetProxy.sol#L89)

	```solidity
	    function removeFunctions(bytes4[] calldata selectors) external {
	```

</details>



## L-8: State Variable Could Be Immutable

State variables that are only changed in the constructor should be declared immutable to save gas. Add the `immutable` attribute to state variables that are only changed in the constructor

<details><summary>3 Found Instances</summary>


- Found in src/kToken.sol [Line: 42](src/kToken.sol#L42)

	```solidity
	    string private _name;
	```

- Found in src/kToken.sol [Line: 43](src/kToken.sol#L43)

	```solidity
	    string private _symbol;
	```

- Found in src/kToken.sol [Line: 44](src/kToken.sol#L44)

	```solidity
	    uint8 private _decimals;
	```

</details>



## L-9: Unchecked Return

Function returns a value but it is ignored. Consider checking the return value.

<details><summary>20 Found Instances</summary>


- Found in src/kAssetRouter.sol [Line: 241](src/kAssetRouter.sol#L241)

	```solidity
	        $.batchIds.add(batchId);
	```

- Found in src/kAssetRouter.sol [Line: 250](src/kAssetRouter.sol#L250)

	```solidity
	        $.vaultPendingProposalIds[vault].add(proposalId);
	```

- Found in src/kAssetRouter.sol [Line: 284](src/kAssetRouter.sol#L284)

	```solidity
	        $.executedProposalIds.add(proposalId);
	```

- Found in src/kAssetRouter.sol [Line: 285](src/kAssetRouter.sol#L285)

	```solidity
	        $.vaultPendingProposalIds[vault].remove(proposalId);
	```

- Found in src/kAssetRouter.sol [Line: 305](src/kAssetRouter.sol#L305)

	```solidity
	        $.vaultPendingProposalIds[vault].remove(proposalId);
	```

- Found in src/kAssetRouter.sol [Line: 306](src/kAssetRouter.sol#L306)

	```solidity
	        $.batchIds.remove(proposal.batchId);
	```

- Found in src/kMinter.sol [Line: 148](src/kMinter.sol#L148)

	```solidity
	        $.userRequests[to_].add(requestId);
	```

- Found in src/kMinter.sol [Line: 179](src/kMinter.sol#L179)

	```solidity
	        $.userRequests[redeemRequest.user].remove(requestId);
	```

- Found in src/kMinter.sol [Line: 211](src/kMinter.sol#L211)

	```solidity
	        $.userRequests[redeemRequest.user].remove(requestId);
	```

- Found in src/kRegistry.sol [Line: 210](src/kRegistry.sol#L210)

	```solidity
	        $.supportedAssets.add(asset);
	```

- Found in src/kRegistry.sol [Line: 263](src/kRegistry.sol#L263)

	```solidity
	        $.vaultAsset[vault].add(asset);
	```

- Found in src/kRegistry.sol [Line: 264](src/kRegistry.sol#L264)

	```solidity
	        $.allVaults.add(vault);
	```

- Found in src/kRegistry.sol [Line: 268](src/kRegistry.sol#L268)

	```solidity
	        $.vaultsByAsset[asset].add(vault);
	```

- Found in src/kRegistry.sol [Line: 296](src/kRegistry.sol#L296)

	```solidity
	        $.vaultAdapters[vault].add(adapter);
	```

- Found in src/kRegistry.sol [Line: 308](src/kRegistry.sol#L308)

	```solidity
	        $.vaultAdapters[vault].remove(adapter);
	```

- Found in src/kStakingVault/kStakingVault.sol [Line: 116](src/kStakingVault/kStakingVault.sol#L116)

	```solidity
	        $.userRequests[msg.sender].add(requestId);
	```

- Found in src/kStakingVault/kStakingVault.sol [Line: 166](src/kStakingVault/kStakingVault.sol#L166)

	```solidity
	        $.userRequests[msg.sender].add(requestId);
	```

- Found in src/kStakingVault/kStakingVault.sol [Line: 188](src/kStakingVault/kStakingVault.sol#L188)

	```solidity
	        $.userRequests[msg.sender].remove(requestId);
	```

- Found in src/kStakingVault/kStakingVault.sol [Line: 215](src/kStakingVault/kStakingVault.sol#L215)

	```solidity
	        $.userRequests[msg.sender].remove(requestId);
	```

- Found in src/kStakingVault/modules/ClaimModule.sol [Line: 65](src/kStakingVault/modules/ClaimModule.sol#L65)

	```solidity
	        $.userRequests[msg.sender].remove(requestId);
	```

</details>



