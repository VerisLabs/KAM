<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>BaseAdapter - KAM Contracts Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../book.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">KAM Contracts Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/VerisLabs/KAM" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="baseadapter"><a class="header" href="#baseadapter">BaseAdapter</a></h1>
<p><a href="https://github.com/VerisLabs/KAM/blob/39577197165fca22f4727dda301114283fca8759/src/adapters/BaseAdapter.sol">Git Source</a></p>
<p><strong>Inherits:</strong>
<a href="/src/abstracts/OptimizedReentrancyGuardTransient.sol/abstract.OptimizedReentrancyGuardTransient.html">OptimizedReentrancyGuardTransient</a></p>
<p>Foundation contract providing essential shared functionality for all protocol adapter implementations</p>
<p><em>This abstract contract serves as the base layer for adapter pattern implementations that integrate external
yield strategies (CEX, DeFi protocols, custodial solutions) with the KAM protocol. Key responsibilities include:
(1) Registry integration to maintain protocol-wide configuration consistency and access control, (2) Asset rescue
mechanisms to recover stuck funds while protecting protocol assets from unauthorized extraction, (3) Standardized
initialization patterns ensuring proper setup across all adapter types, (4) Version tracking for upgrade management
and compatibility checks, (5) Role-based access control validation through registry lookups. Adapters enable the
protocol to generate yield from diverse sources while maintaining a unified interface for the kAssetRouter. Each
adapter implementation (CustodialAdapter, AaveAdapter, etc.) extends this base to handle strategy-specific logic
while inheriting critical safety features and protocol integration. The ERC-7201 storage pattern prevents collisions
during upgrades and enables safe composition with other base contracts.</em></p>
<h2 id="state-variables"><a class="header" href="#state-variables">State Variables</a></h2>
<h3 id="k_asset_router"><a class="header" href="#k_asset_router">K_ASSET_ROUTER</a></h3>
<p>Registry lookup key for the kAssetRouter singleton contract</p>
<p><em>Used to retrieve and validate the kAssetRouter address from registry. Only kAssetRouter
can trigger adapter deposits/redemptions, ensuring centralized control over asset flows.</em></p>
<pre><code class="language-solidity">bytes32 internal constant K_ASSET_ROUTER = keccak256("K_ASSET_ROUTER");
</code></pre>
<h3 id="base_adapter_storage_location"><a class="header" href="#base_adapter_storage_location">BASE_ADAPTER_STORAGE_LOCATION</a></h3>
<pre><code class="language-solidity">bytes32 private constant BASE_ADAPTER_STORAGE_LOCATION =
    0x5547882c17743d50a538cd94a34f6308d65f7005fe26b376dcedda44d3aab800;
</code></pre>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<h3 id="_getbaseadapterstorage"><a class="header" href="#_getbaseadapterstorage">_getBaseAdapterStorage</a></h3>
<p><em>Returns the base adapter storage pointer</em></p>
<pre><code class="language-solidity">function _getBaseAdapterStorage() internal pure returns (BaseAdapterStorage storage $);
</code></pre>
<h3 id="__baseadapter_init"><a class="header" href="#__baseadapter_init">__BaseAdapter_init</a></h3>
<p>Initializes the base adapter with registry integration and metadata</p>
<p><em>This internal initialization establishes the foundation for all adapter implementations. The process:
(1) Validates initialization hasn't occurred to prevent reinitialization in proxy patterns, (2) Ensures
registry address is valid since all access control depends on it, (3) Sets adapter metadata for tracking
and identification, (4) Marks initialization complete. Must be called by inheriting adapter contracts
during their initialization phase to establish proper protocol integration. The internal visibility
ensures only inheriting contracts can initialize, preventing external manipulation.</em></p>
<pre><code class="language-solidity">function __BaseAdapter_init(address registry_, string memory name_, string memory version_) internal;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>registry_</code></td><td><code>address</code></td><td>The kRegistry contract address for protocol configuration and access control</td></tr>
<tr><td><code>name_</code></td><td><code>string</code></td><td>Human-readable adapter identifier (e.g., "CustodialAdapter", "AaveV3Adapter")</td></tr>
<tr><td><code>version_</code></td><td><code>string</code></td><td>Semantic version string for upgrade management (e.g., "1.0.0")</td></tr>
</tbody></table>
</div>
<h3 id="registry"><a class="header" href="#registry">registry</a></h3>
<p>Returns the registry contract address</p>
<p><em>Reverts if contract not initialized</em></p>
<pre><code class="language-solidity">function registry() external view returns (address);
</code></pre>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>address</code></td><td>The kRegistry contract address</td></tr>
</tbody></table>
</div>
<h3 id="_registry"><a class="header" href="#_registry">_registry</a></h3>
<p>Returns the registry contract interface</p>
<pre><code class="language-solidity">function _registry() internal view returns (IkRegistry);
</code></pre>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>IkRegistry</code></td><td>IkRegistry interface for registry interaction</td></tr>
</tbody></table>
</div>
<h3 id="rescueassets"><a class="header" href="#rescueassets">rescueAssets</a></h3>
<p>Rescues accidentally sent assets preventing permanent loss in the adapter</p>
<p><em>Critical safety mechanism for recovering tokens or ETH stuck in the adapter through user error
or airdrops. The rescue process: (1) Validates admin authorization to prevent unauthorized extraction,
(2) Ensures recipient address validity to prevent burning funds, (3) For ETH (asset_=address(0)):
validates balance and uses low-level call for transfer, (4) For ERC20: critically verifies the token
is NOT a registered protocol asset to protect user deposits, then validates balance and uses
SafeTransferLib. Protocol assets are blocked to prevent admin abuse and maintain user trust. This
function is essential for adapter contracts that may receive unexpected transfers.</em></p>
<pre><code class="language-solidity">function rescueAssets(address asset_, address to_, uint256 amount_) external payable;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>asset_</code></td><td><code>address</code></td><td>The asset to rescue (address(0) for ETH, token address for ERC20)</td></tr>
<tr><td><code>to_</code></td><td><code>address</code></td><td>The recipient address for rescued assets (cannot be zero address)</td></tr>
<tr><td><code>amount_</code></td><td><code>uint256</code></td><td>The quantity to rescue (must not exceed available balance)</td></tr>
</tbody></table>
</div>
<h3 id="name"><a class="header" href="#name">name</a></h3>
<p>Returns the adapter's name</p>
<pre><code class="language-solidity">function name() external view returns (string memory);
</code></pre>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>string</code></td><td>Human readable adapter name</td></tr>
</tbody></table>
</div>
<h3 id="version"><a class="header" href="#version">version</a></h3>
<p>Returns the adapter's version</p>
<pre><code class="language-solidity">function version() external view returns (string memory);
</code></pre>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>string</code></td><td>Version string</td></tr>
</tbody></table>
</div>
<h3 id="_isadmin"><a class="header" href="#_isadmin">_isAdmin</a></h3>
<p>Checks if an address has admin role for adapter management</p>
<p><em>Admins can rescue assets and configure adapter parameters. Access control through registry.</em></p>
<pre><code class="language-solidity">function _isAdmin(address user) internal view returns (bool);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>user</code></td><td><code>address</code></td><td>The address to check for admin privileges</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>bool</code></td><td>Whether the address is registered as an admin</td></tr>
</tbody></table>
</div>
<h3 id="_iskassetrouter"><a class="header" href="#_iskassetrouter">_isKAssetRouter</a></h3>
<p>Checks if an address is the kAssetRouter contract</p>
<p><em>Only kAssetRouter can trigger deposits/redemptions in adapters, ensuring centralized control
over asset flows between vaults and external strategies. Critical for maintaining protocol integrity.</em></p>
<pre><code class="language-solidity">function _isKAssetRouter(address user) internal view returns (bool);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>user</code></td><td><code>address</code></td><td>The address to validate against kAssetRouter</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>bool</code></td><td>Whether the address is the registered kAssetRouter</td></tr>
</tbody></table>
</div>
<h3 id="_isasset"><a class="header" href="#_isasset">_isAsset</a></h3>
<p>Checks if an asset is registered in the protocol</p>
<p><em>Registered assets (USDC, WBTC, etc.) cannot be rescued to protect user deposits.
This distinction ensures protocol assets remain under vault control.</em></p>
<pre><code class="language-solidity">function _isAsset(address asset) internal view returns (bool);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>asset</code></td><td><code>address</code></td><td>The asset address to check</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>bool</code></td><td>Whether the asset is a registered protocol asset</td></tr>
</tbody></table>
</div>
<h2 id="events"><a class="header" href="#events">Events</a></h2>
<h3 id="rescuedassets"><a class="header" href="#rescuedassets">RescuedAssets</a></h3>
<p>Emitted when ERC20 tokens are rescued from the adapter to prevent permanent loss</p>
<p><em>Rescue mechanism restricted to non-protocol assets to protect user funds. Typically recovers
accidentally sent tokens or airdrops that would otherwise be locked in the adapter contract.</em></p>
<pre><code class="language-solidity">event RescuedAssets(address indexed asset, address indexed to, uint256 amount);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>asset</code></td><td><code>address</code></td><td>The ERC20 token address being rescued (must not be a registered protocol asset)</td></tr>
<tr><td><code>to</code></td><td><code>address</code></td><td>The recipient address receiving the rescued tokens</td></tr>
<tr><td><code>amount</code></td><td><code>uint256</code></td><td>The quantity of tokens rescued</td></tr>
</tbody></table>
</div>
<h3 id="rescuedeth"><a class="header" href="#rescuedeth">RescuedETH</a></h3>
<p>Emitted when native ETH is rescued from the adapter contract</p>
<p><em>Separate from ERC20 rescue due to different transfer mechanisms. Prevents ETH from being
permanently locked if sent to the adapter accidentally.</em></p>
<pre><code class="language-solidity">event RescuedETH(address indexed to, uint256 amount);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>to</code></td><td><code>address</code></td><td>The recipient address receiving the rescued ETH</td></tr>
<tr><td><code>amount</code></td><td><code>uint256</code></td><td>The quantity of ETH rescued in wei</td></tr>
</tbody></table>
</div>
<h2 id="structs"><a class="header" href="#structs">Structs</a></h2>
<h3 id="baseadapterstorage"><a class="header" href="#baseadapterstorage">BaseAdapterStorage</a></h3>
<p><em>Storage struct following ERC-7201 namespaced storage pattern for upgrade safety.
Prevents storage collisions when adapters inherit from multiple base contracts.</em></p>
<p><strong>Note:</strong>
storage-location: erc7201:kam.storage.BaseAdapter</p>
<pre><code class="language-solidity">struct BaseAdapterStorage {
    address registry;
    bool initialized;
    string name;
    string version;
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../src/adapters/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../src/adapters/CustodialAdapter.sol/contract.CustodialAdapter.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../src/adapters/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../src/adapters/CustodialAdapter.sol/contract.CustodialAdapter.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../../solidity.min.js"></script>


    </div>
    </body>
</html>
