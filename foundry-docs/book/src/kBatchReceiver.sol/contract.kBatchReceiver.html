<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>kBatchReceiver - KAM Contracts Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../book.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">KAM Contracts Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/VerisLabs/KAM" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="kbatchreceiver"><a class="header" href="#kbatchreceiver">kBatchReceiver</a></h1>
<p><a href="https://github.com/VerisLabs/KAM/blob/39577197165fca22f4727dda301114283fca8759/src/kBatchReceiver.sol">Git Source</a></p>
<p><strong>Inherits:</strong>
<a href="/src/interfaces/IkBatchReceiver.sol/interface.IkBatchReceiver.html">IkBatchReceiver</a></p>
<p>Minimal proxy contract implementation for isolated batch asset distribution in the KAM protocol</p>
<p>*This contract implements the minimal proxy pattern where each batch redemption gets its own dedicated
receiver instance for secure and efficient asset distribution. The implementation provides several key features:
(1) Minimal Proxy Pattern: Uses EIP-1167 minimal proxy deployment to reduce gas costs per batch while maintaining
full isolation between different settlement periods, (2) Batch Isolation: Each receiver handles exactly one batch,
preventing cross-contamination and simplifying accounting, (3) Access Control: Only the originating kMinter can
interact with receivers, ensuring strict security throughout the distribution process, (4) Asset Distribution:
Manages the final step of redemption where settled assets flow from kMinter to individual users, (5) Emergency
Recovery: Provides safety mechanisms for accidentally sent tokens while protecting settlement assets.
Technical Implementation Notes:</p>
<ul>
<li>Uses immutable kMinter reference set at construction for gas efficiency</li>
<li>Implements strict batch ID validation to prevent operational errors</li>
<li>Supports both ERC20 and native ETH rescue operations</li>
<li>Emits comprehensive events for off-chain tracking and reconciliation*</li>
</ul>
<h2 id="state-variables"><a class="header" href="#state-variables">State Variables</a></h2>
<h3 id="kminter"><a class="header" href="#kminter">kMinter</a></h3>
<p>Address of the kMinter contract authorized to interact with this receiver</p>
<p><em>Immutable reference set at construction time for gas efficiency and security. This address
has exclusive permission to call pullAssets() and rescueAssets(), ensuring only the originating
kMinter can manage asset distribution for this specific batch. The immutable nature prevents
modification and reduces gas costs for access control checks.</em></p>
<pre><code class="language-solidity">address public immutable kMinter;
</code></pre>
<h3 id="asset"><a class="header" href="#asset">asset</a></h3>
<p>Address of the underlying asset contract this receiver will distribute</p>
<p><em>Set during initialization to specify which token type (USDC, WBTC, etc.) this receiver
manages. Must match the asset type that was originally deposited and requested for redemption
in the associated batch. Used for asset transfer operations and rescue validation.</em></p>
<pre><code class="language-solidity">address public asset;
</code></pre>
<h3 id="batchid"><a class="header" href="#batchid">batchId</a></h3>
<p>Unique batch identifier linking this receiver to a specific redemption batch</p>
<p><em>Set during initialization to establish the connection between this receiver and the batch
of redemption requests it serves. Used for validation in pullAssets() to ensure operations
are performed on the correct batch, preventing cross-contamination between settlement periods.</em></p>
<pre><code class="language-solidity">bytes32 public batchId;
</code></pre>
<h3 id="isinitialised"><a class="header" href="#isinitialised">isInitialised</a></h3>
<p>Initialization state flag preventing duplicate configuration</p>
<p><em>Boolean flag that prevents re-initialization after the receiver has been configured.
Set to true during the initialize() call to ensure batch parameters can only be set once,
maintaining the integrity of the receiver's purpose and preventing operational errors.</em></p>
<pre><code class="language-solidity">bool public isInitialised;
</code></pre>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<h3 id="constructor"><a class="header" href="#constructor">constructor</a></h3>
<p>Deploys a new kBatchReceiver with immutable kMinter authorization</p>
<p><em>Constructor for minimal proxy implementation that establishes the sole authorized caller.
The kMinter address is set as immutable during deployment to ensure gas efficiency and prevent
unauthorized modifications. This constructor is called once per batch receiver deployment,
establishing the security foundation for all subsequent operations. The address validation
ensures no receiver can be deployed with invalid authorization.</em></p>
<pre><code class="language-solidity">constructor(address _kMinter);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_kMinter</code></td><td><code>address</code></td><td>Address of the kMinter contract that will have exclusive interaction rights</td></tr>
</tbody></table>
</div>
<h3 id="initialize"><a class="header" href="#initialize">initialize</a></h3>
<p>Configures the receiver with batch-specific parameters after deployment</p>
<p><em>Post-deployment initialization that links this receiver to a specific batch and asset type.
This two-step deployment pattern (constructor + initialize) enables efficient minimal proxy usage
where the implementation is deployed once and initialization customizes each instance. The function:
(1) prevents duplicate initialization with isInitialised flag, (2) validates asset address,
(3) stores batch parameters for operational use, (4) emits initialization event for tracking.
Only callable once per receiver instance to maintain batch isolation integrity.</em></p>
<pre><code class="language-solidity">function initialize(bytes32 _batchId, address _asset) external;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_batchId</code></td><td><code>bytes32</code></td><td>The unique batch identifier this receiver will serve</td></tr>
<tr><td><code>_asset</code></td><td><code>address</code></td><td>Address of the underlying asset contract (USDC, WBTC, etc.) to distribute</td></tr>
</tbody></table>
</div>
<h3 id="pullassets"><a class="header" href="#pullassets">pullAssets</a></h3>
<p>Transfers settled assets from the receiver to a redemption user completing their withdrawal</p>
<p><em>This is the core asset distribution function that fulfills redemption requests after batch settlement.
The process works as follows: (1) kMinter calls this function with user's proportional share, (2) receiver
validates the batch ID matches to prevent cross-batch contamination, (3) assets are transferred directly
to the user completing their redemption. Only callable by the authorized kMinter contract to maintain strict
access control. This function is typically called multiple times per batch as individual users claim their
settled redemptions, ensuring fair and orderly asset distribution.</em></p>
<pre><code class="language-solidity">function pullAssets(address receiver, uint256 amount, bytes32 _batchId) external;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>receiver</code></td><td><code>address</code></td><td>The address that will receive the settled assets (the user completing redemption)</td></tr>
<tr><td><code>amount</code></td><td><code>uint256</code></td><td>The quantity of assets to transfer based on the user's proportional share</td></tr>
<tr><td><code>_batchId</code></td><td><code>bytes32</code></td><td>The batch identifier for validation (must match this receiver's configured batch)</td></tr>
</tbody></table>
</div>
<h3 id="rescueassets"><a class="header" href="#rescueassets">rescueAssets</a></h3>
<p>Emergency recovery function for accidentally sent assets to prevent permanent loss</p>
<p><em>Provides a safety mechanism for recovering tokens or ETH that were mistakenly sent to the receiver
outside of normal settlement operations. The function handles both ERC20 tokens and native ETH recovery.
For ERC20 tokens, it validates that the rescue asset is not the receiver's designated settlement asset
(to prevent interfering with normal operations). Only the authorized kMinter can execute rescues, ensuring
recovered assets return to the proper custodial system. Essential for maintaining protocol security while
preventing accidental asset loss during the receiver contract's operational lifecycle.</em></p>
<pre><code class="language-solidity">function rescueAssets(address asset_) external payable;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>asset_</code></td><td><code>address</code></td><td>The contract address of the asset to rescue (use address(0) for native ETH recovery)</td></tr>
</tbody></table>
</div>
<h3 id="_checkminter"><a class="header" href="#_checkminter">_checkMinter</a></h3>
<p><em>Only callable by kMinter</em></p>
<pre><code class="language-solidity">function _checkMinter(address minter) private view;
</code></pre>
<h3 id="_checkaddressnotzero"><a class="header" href="#_checkaddressnotzero">_checkAddressNotZero</a></h3>
<p><em>Checks address is not zero</em></p>
<pre><code class="language-solidity">function _checkAddressNotZero(address address_) private pure;
</code></pre>
<h3 id="_checkamountnotzero"><a class="header" href="#_checkamountnotzero">_checkAmountNotZero</a></h3>
<p><em>Checks amount is not zero</em></p>
<pre><code class="language-solidity">function _checkAmountNotZero(uint256 amount) private pure;
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../src/kAssetRouter.sol/contract.kAssetRouter.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../src/kMinter.sol/contract.kMinter.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../src/kAssetRouter.sol/contract.kAssetRouter.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../src/kMinter.sol/contract.kMinter.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../solidity.min.js"></script>


    </div>
    </body>
</html>
